<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S.P.S Intertech Portal</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="https://thamanoonni.github.io/ta/icon.png">
    <link rel="apple-touch-icon" href="https://thamanoonni.github.io/ta/icon.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // ******************************************************
        // 1. ตั้งค่าการเชื่อมต่อ (URL เดิมของคุณ)
        // ******************************************************
        const API_URL = 'https://script.google.com/macros/s/AKfycbz1H8BUqtNHfgGwxnbJzUUI9Y63Qdq-danHbSsmMZP6oTXYcdjyhHZAapN7MybRFJ4V/exec'; 
    </script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --bg-blue: #42a5f5;
            --bg-green: #66bb6a;
            --bg-red: #ef5350;
            --bg-orange: #ffa726;
            --bg-gray: #8d6e63;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Prompt', sans-serif; background-color: #f4f6f8; margin: 0; padding: 0; color: #333; overflow-x: hidden; }
        
        .view-section { display: none; min-height: 100vh; }
        .active-view { display: block; }
        
        /* --- Login Page --- */
        .login-container {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100vh; background: linear-gradient(135deg, #2c3e50, #4ca1af); color: white; padding: 20px;
        }
        .login-box {
            background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            width: 100%; max-width: 400px; text-align: center; color: #333;
        }
        .login-input {
            width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px;
            font-family: 'Prompt'; font-size: 16px;
        }
        .login-btn {
            width: 100%; padding: 12px; background: var(--primary-color); color: white; border: none;
            border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 10px; transition: 0.3s;
        }
        .login-btn:hover { background: #1a252f; }

        /* --- Portal Page --- */
        .portal-header {
            background: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100;
        }
        .profile-section { display: flex; align-items: center; gap: 15px; }
        .profile-img { 
            width: 50px; height: 50px; border-radius: 50%; object-fit: cover; 
            border: 2px solid #eee; background-color: #ddd;
        }
        .portal-content { padding-bottom: 80px; }
        .portal-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; padding: 20px; max-width: 800px; margin: 0 auto;
        }
        .app-icon {
            background: white; border-radius: 15px; padding: 20px 10px; text-align: center; cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05); transition: transform 0.2s; border: 1px solid transparent;
            position: relative; /* สำหรับ Badge */
        }
        .app-icon:hover { transform: translateY(-3px); border-color: var(--bg-blue); }
        .app-icon i { font-size: 30px; margin-bottom: 10px; color: var(--primary-color); }
        .app-icon div { font-size: 13px; font-weight: 500; }
        
        /* Badge สำหรับ Last Period */
        /*
        .period-badge {
            position: absolute; top: 5px; right: 5px; 
            background-color: #e8f5e9; color: #2e7d32; 
            font-size: 9px; padding: 2px 6px; border-radius: 10px; border: 1px solid #c8e6c9;
        }
        */
        /* แก้ไข Badge ให้อยู่บรรทัดเดียวกับชื่อ */
        .period-badge {
            display: inline-block;       /* แสดงผลแนวนอน */
            margin-left: 5px;            /* เว้นห่างจากชื่อทางซ้าย 5px */
            margin-top: 0;               /* เอา margin ด้านบนออก */
            background-color: #e8f5e9; 
            color: #2e7d32; 
            font-size: 10px;             
            padding: 2px 6px;            
            border-radius: 10px;         
            border: 1px solid #c8e6c9;   
            vertical-align: middle;      /* จัดกึ่งกลางแนวตั้งกับตัวหนังสือ */
        }

        .portal-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; padding: 15px; text-align: center;
            border-top: 1px solid #f0f0f0; box-shadow: 0 -2px 10px rgba(0,0,0,0.02);
            display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 10px;
            z-index: 100;
        }
        .footer-logo { height: 35px; width: auto; opacity: 1.0; }
        .footer-text { font-size: 16px; color: #2c3e50; font-weight: 600; }

        /* --- App Shared Styles --- */
        .dashboard-wrapper { padding: 10px; max-width: 800px; margin: 0 auto; padding-bottom: 50px; }
        .header-section { background: white; padding: 10px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 10px; position: relative; }
        .back-home-btn { position: absolute; top: 10px; right: 10px; background: #eee; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; }
        .brand-box { display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px; margin-bottom: 10px; }
        .logo-img { height: 40px; width: auto; max-width: 80px; object-fit: contain; }
        .company-info h2 { margin: 0; line-height: 1.0; font-size: clamp(13px, 4.5vw, 20px); color: var(--primary-color); font-weight: 700; }
        .company-info p { margin: 0; font-size: 12px; color: #888; }
        .last-update { font-size: 11px; color: #999; text-align: right; margin-bottom: 5px; }
        .input-group { display: flex; gap: 10px; align-items: center; }
        input[type="month"] { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Prompt', sans-serif; font-size: 16px; background: #f9f9f9; }
        .check-btn { flex: 0 0 80px; padding: 10px; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }

        /* Summary Cards */
        .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 15px; text-align: center; }
        .sum-card { padding: 8px 2px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor:pointer; background: white;}
        .sum-card small { font-size: 9px; font-weight: 600; display: block; margin-bottom: 2px; opacity:0.9; }
        .sum-card .value { font-size: 12px; font-weight: bold; word-break: break-all;}
        
        /* Colors */
        .c-blue { background-color: var(--bg-blue); color: white; }
        .c-green { background-color: var(--bg-green); color: white; }
        .c-red { background-color: var(--bg-red); color: white; }
        .c-orange { background-color: var(--bg-orange); color: white; }
        .c-gray { background-color: var(--bg-gray); color: white; }

        /* Chart & List */
        .chart-wrapper { background: white; border-radius: 12px; padding: 10px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .chart-title { font-size: 14px; font-weight: 600; margin-bottom: 10px; padding-left: 5px; border-left: 4px solid var(--primary-color); color: var(--primary-color); }
        .chart-box { height: 250px; position: relative; }

        .list-header { font-weight: bold; margin-bottom: 10px; margin-top: 15px; display: flex; justify-content: space-between; align-items: center;}
        .list-item { background: white; border-radius: 10px; padding: 12px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 5px solid transparent; cursor: pointer; }
        
        .row-detail { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 13px; }
        .text-red { color: #d32f2f; font-weight: bold; }
        .text-blue { color: #1976d2; font-weight: bold; }
        .text-orange { color: #f57c00; font-weight: bold; }
        .text-green { color: #66bb6a; font-weight: bold; }
        .text-gray { color: #757575; }

        /* Job Cost Specific Styles */
        .job-card { background: white; border-radius: 10px; padding: 12px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .job-pn { font-weight: bold; color: var(--primary-color); font-size: 15px; }
        .job-name { font-size: 12px; color: #666; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        .job-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 3px; }
        .pct-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #eee; }
        .pct-plus { background: #e8f5e9; color: #2e7d32; }
        .pct-minus { background: #ffebee; color: #c62828; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 99999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 90%; max-width: 600px; max-height: 90vh; border-radius: 15px; padding: 20px; position: relative; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .close-btn { position: absolute; top: 15px; right: 15px; background: #f1f1f1; border: none; width: 30px; height: 30px; border-radius: 50%; font-size: 18px; color: #666; cursor: pointer; }
        .modal-title { font-size: 18px; font-weight: bold; color: var(--primary-color); margin-bottom: 5px; }
        
        #loading, #emptyState { text-align: center; color: #666; margin-top: 20px; display: none; }
        .my-swal-zindex { z-index: 200000 !important; }
        .swal2-container { z-index: 200000 !important; }
        #categoryModal { z-index: 9000 !important; }
        #detailModal { z-index: 9500 !important; }
        /* --- JOB COST: TABLE LAYOUT --- */
        
        /* กำหนดโครงสร้างคอลัมน์ (PN, ชื่อ, Qty, ขาย, ต้นทุน, กำไร) */
        /* แก้ไข Grid Template ใหม่ */
        .job-table-template {
            display: grid;
            /* สูตรใหม่: รวมกันได้ 96% (เผื่อที่ให้ Gap ไม่ให้ตกบรรทัด) */
            /* PN | Qty | ขาย | ต้นทุน | กำไร | % */
            grid-template-columns: 25% 11% 16% 16% 16% 12%; 
            gap: 2px; 
            padding: 8px 2px; /* ลด Padding ซ้ายขวา */
            align-items: center;
            font-size: 10px; /* ลดขนาดตัวหนังสือลงเล็กน้อย */
            border-bottom: 1px solid #eee;
        }

        /* จัดแนวข้อความ */
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .text-truncate { 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; /* ถ้าชื่อยาวเกินไปให้เป็น ... */
        }

        /* ส่วนหัวตาราง (Header) */
        .job-table-header-row {
            background-color: #eceff1;
            font-weight: bold;
            color: #455a64;
            border-radius: 6px 6px 0 0; /* มนมุมบน */
            font-size: 10px;
        }

        /* ส่วนเนื้อหา (Data Rows) */
        .job-data-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        /* Zebra Striping (สลับสี) */
        .job-data-row:nth-child(odd) { background-color: #ffffff; }
        .job-data-row:nth-child(even) { background-color: #f1f8e9; } /* สีเขียวอ่อนจางๆ */
        
        /* Effect ตอนกด */
        .job-data-row:active { background-color: #bbdefb; }

        /* --- JOB COST: STICKY HEADER SYSTEM --- */
        
        /* 1. กรอบหลัก กำหนดความสูงเพื่อให้เกิด Scroll ภายใน */
        .job-content-wrapper {
            height: calc(100vh - 190px); /* ความสูงจอ - ความสูง Header หลัก (Logo+Menu) โดยประมาณ */
            overflow-y: auto;            /* ให้ Scroll ได้เฉพาะในนี้ */
            padding-bottom: 60px;        /* เผื่อที่ Footer */
            position: relative;
        }

        /* 2. หัวตารางที่จะติดหนึบ (Sticky) */
        .job-sticky-header {
            position: sticky;       /* สั่งให้ติดหนึบ */
            top: 0;                 /* ติดที่ขอบบนสุดของพื้นที่ Scroll */
            z-index: 10;            /* ให้ลอยอยู่เหนือเนื้อหา */
            background-color: #f4f6f8; /* สีพื้นหลัง (ต้องมี เพื่อบังเนื้อหาที่เลื่อนผ่าน) */
            padding-top: 5px;
            padding-bottom: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* เงาเล็กน้อยให้ดูมีมิติ */
        }
        
    </style>
</head>
<body>

    <div id="view-login" class="view-section active-view">
        <div class="login-container">
            <div class="login-box">
                <img src="https://drive.google.com/thumbnail?id=1gyn_N2ZR52d17UgWmta4Q3JjegLlbcaO&sz=w1000" style="height:60px; margin-bottom:10px;">
                <h3 style="margin:0 0 20px 0;">เข้าสู่ระบบ</h3>
                <input type="text" id="username" class="login-input" placeholder="รหัสพนักงาน/Username">
                <input type="password" id="password" class="login-input" placeholder="รหัสผ่าน">
                <button onclick="doLogin()" class="login-btn">Login</button>
            </div>
        </div>
    </div>

    <div id="view-set-password" class="view-section">
        <div class="login-container">
            <div class="login-box">
                <h3 style="margin:0 0 10px 0;">ตั้งรหัสผ่านใหม่</h3>
                <p style="font-size:12px; color:#666; margin-bottom:20px;">บัญชีของคุณยังไม่มีรหัสผ่าน<br>กรุณาตั้งรหัสผ่านเพื่อเข้าใช้งาน</p>
                <input type="password" id="newPass" class="login-input" placeholder="รหัสผ่านใหม่ (ขั้นต่ำ 6 ตัว)">
                <input type="password" id="confirmPass" class="login-input" placeholder="ยืนยันรหัสผ่านอีกครั้ง">
                <button onclick="doSetNewPassword()" class="login-btn" style="background-color: var(--bg-green);">บันทึกรหัสผ่าน</button>
                <button onclick="switchView('view-login')" class="login-btn" style="background-color: #999; margin-top:5px;">ยกเลิก</button>
            </div>
        </div>
    </div>

    <div id="view-portal" class="view-section">
        <div class="portal-header">
            <div class="profile-section">
                <img id="userImg" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="profile-img">
                <div>
                    <div style="font-size:12px; color:#888;">ยินดีต้อนรับ</div>
                    <div style="font-weight:bold; font-size:16px;" id="dispName">-</div>
                </div>
            </div>
            <button onclick="doLogout()" style="background:none; border:none; color:#ef5350; cursor:pointer; font-size:12px;">
                <i class="fa-solid fa-power-off"></i><br>ออกระบบ
            </button>
        </div>

        <div class="portal-content">
            <div class="portal-grid" id="appGrid">
                <div style="text-align:center; grid-column:1/-1; color:#999;">กำลังโหลดรายการระบบ...</div>
            </div>
        </div>

        <div class="portal-footer">
            <img src="https://drive.google.com/thumbnail?id=1gyn_N2ZR52d17UgWmta4Q3JjegLlbcaO&sz=w1000" class="footer-logo">
            <div class="footer-text">S.P.S Intertech Public Co.,Ltd.</div>
        </div>
    </div>

    <div id="view-app-sale" class="view-section">
        <div class="dashboard-wrapper">
            <div class="header-section">
                <button class="back-home-btn" onclick="switchView('view-portal')"><i class="fa-solid fa-house"></i> เมนูหลัก</button>
                <div class="brand-box">
                   <img src="https://drive.google.com/thumbnail?id=1gyn_N2ZR52d17UgWmta4Q3JjegLlbcaO&sz=w1000" alt="Logo" class="logo-img">
                   <div class="company-info"><h2>S.P.S Intertech</h2><p>Sales Dashboard</p></div>
                </div>
                <div class="last-update">Update: <span id="lastUpdatedTxt">-</span></div>
                <div class="input-group">
                  <input type="month" id="monthPicker" onchange="onDateChanged('sale')">
                  <button class="check-btn" onclick="processSaleData()">Check</button>
                </div>
            </div>

            <div id="dashboardContent" style="display:none;">
                <div class="summary-grid">
                  <div class="sum-card c-blue" onclick="openCategoryModal(3)"><small>ยอดขายรวม</small><div class="value" id="sumSales">0</div></div>
                  <div class="sum-card c-green" onclick="openCategoryModal(0)"><small>ส่งแล้ว</small><div class="value" id="sumSent">0</div></div>
                  <div class="sum-card c-orange" onclick="openCategoryModal(1)"><small>รอส่ง</small><div class="value" id="sumBacklog">0</div></div>
                  <div class="sum-card c-red" onclick="openCategoryModal(2)"><small>Past Due</small><div class="value" id="sumDue">0</div></div>
                </div>

                <div class="chart-wrapper">
                     <div class="chart-title" id="chartTitleText">ภาพรวมประจำเดือน</div>
                     <div class="chart-box" style="display: flex; flex-direction: row; align-items: center; justify-content: space-between; padding: 10px; height: auto; min-height: 250px;">
                        <div style="width: 55%; height: 220px; position: relative;"><canvas id="overviewChart"></canvas></div>
                        <div id="customLegend" style="width: 45%; padding-left: 10px;"></div>
                     </div>
                </div>

                <div class="chart-wrapper">
                     <div class="chart-title">Top 5 ยอดขายสูงสุด</div>
                     <div class="chart-box" style="height: 300px;"><canvas id="customerChart"></canvas></div>
                </div>

                <div class="list-header"><span>รายละเอียดลูกค้า</span><span style="font-size:11px; color:#666;">กดเพื่อดู Due Date</span></div>
                <div id="dataList"></div>
            </div>
            
            <div id="loadingSale" style="display:none; text-align:center; margin-top:20px;">กำลังโหลดข้อมูล...</div>
        </div>
    </div>

    <div id="view-app-jobcost" class="view-section">
        <div class="dashboard-wrapper">
            <div class="header-section">
                <button class="back-home-btn" onclick="switchView('view-portal')"><i class="fa-solid fa-house"></i> เมนูหลัก</button>
                <div class="brand-box">
                   <img src="https://drive.google.com/thumbnail?id=1gyn_N2ZR52d17UgWmta4Q3JjegLlbcaO&sz=w1000" alt="Logo" class="logo-img">
                   <div class="company-info"><h2>S.P.S Intertech</h2><p>Job Closing Cost</p></div>
                </div>
                <div class="input-group" style="margin-top:10px;">
                  <input type="month" id="jobMonthPicker" onchange="onDateChanged('job')">
                  <button class="check-btn" onclick="processJobCostData()">Check</button>
                </div>
            </div>

            <div id="jobContent" style="display:none;">
                
                <div class="job-content-wrapper">

                    <div class="summary-grid">
                        <div class="sum-card c-blue"><small>ยอดขายรวม</small><div class="value" id="jobSumRev">0</div></div>
                        <div class="sum-card c-orange"><small>ต้นทุนรวม</small><div class="value" id="jobSumCost">0</div></div>
                        <div class="sum-card c-green"><small>กำไรขั้นต้น</small><div class="value" id="jobSumProfit">0</div></div>
                        <div class="sum-card c-gray"><small>% Margin</small><div class="value" id="jobSumPct">0%</div></div>
                    </div>

                    <div class="job-sticky-header">
                        <div class="list-header" style="margin-bottom:5px; padding:0 2px;">
                            <span>สรุปรายสินค้า (Group by PN)</span>
                        </div>
                        <div class="job-table-template job-table-header-row">
                            <div>PN</div>
                            <div class="text-right">Qty</div>
                            <div class="text-right">ยอดขาย</div>
                            <div class="text-right">ต้นทุน</div>
                            <div class="text-right">กำไร</div>
                            <div class="text-right">%</div>
                        </div>
                    </div>

                    <div id="jobList"></div>
                    
                </div>
            </div>

            <div id="loadingJob" style="display:none; text-align:center; margin-top:20px;">กำลังโหลดข้อมูล...</div>
            <div id="emptyJob" style="display:none; text-align:center; margin-top:20px; color:#666;">ไม่พบข้อมูลในเดือนนี้</div>
        </div>
    </div>

    <div class="modal-overlay" id="detailModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()">&times;</button>
            <div class="modal-title" id="modalCustName">-</div>
            <div style="display:flex; justify-content:space-between; align-items:center; font-size:12px; color:#666; margin-bottom:15px;">
                <span>รายละเอียดแยกตามกำหนดส่ง</span>
                <span id="modalCustTotal" style="font-weight:bold; color:#2c3e50; font-size:14px;"></span>
            </div>
            <div class="chart-box" style="height: 250px;"><canvas id="detailChart"></canvas></div>
            <div id="modalTable" style="margin-top:15px; font-size:12px;"></div>
        </div>
    </div>

    <div class="modal-overlay" id="categoryModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeCategoryModal()">&times;</button>
            <div class="modal-title" id="catModalTitle">-</div>
            <div id="catModalSubtitle" style="font-size:14px; color:#2c3e50; font-weight:bold; margin-bottom:10px;">-</div>
            <div style="height: 400px; overflow-y: auto; overflow-x: hidden; border: 1px solid #eee; padding: 5px;">
                <div id="categoryChartContainer" style="position: relative; height: 300px;"> 
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // install
        // 2. Logic สำหรับปุ่ม "ติดตั้งลงเครื่อง"
  let deferredPrompt;
  
  window.addEventListener('beforeinstallprompt', (e) => {
    // ป้องกันไม่ให้ Chrome โชว์แถบอัตโนมัติ (เราจะโชว์เอง)
    e.preventDefault();
    deferredPrompt = e;
    
    // เรียกฟังก์ชันแสดงปุ่มติดตั้ง (ท่านต้องสร้างปุ่มนี้ใน HTML)
    showInstallPromotion(); 
  });

  function showInstallPromotion() {
      // สร้างปุ่มติดตั้งลอยขึ้นมา หรือ แทรกในหน้า Login
      // ตัวอย่าง: ใช้ SweetAlert ที่ท่านมีอยู่แล้ว
      Swal.fire({
          title: 'ติดตั้งแอป',
          text: 'เพื่อความสะดวกในการใช้งาน',
          icon: 'info',
          showCancelButton: true,
          confirmButtonText: 'ติดตั้งเลย',
          cancelButtonText: 'ไว้ทีหลัง',
          confirmButtonColor: '#0d6efd'
      }).then((result) => {
          if (result.isConfirmed) {
              // สั่งให้ติดตั้ง
              deferredPrompt.prompt();
              deferredPrompt.userChoice.then((choiceResult) => {
                  if (choiceResult.outcome === 'accepted') {
                      console.log('User accepted the A2HS prompt');
                  }
                  deferredPrompt = null;
              });
          }
      });
  }
        // end install

        
        // ******************************************************
        // SYSTEM LOGIC (Core)
        // ******************************************************
        
        let currentUser = null;
        let lastJobPeriodGlobal = ""; // เก็บค่าเดือนล่าสุดของ Job Cost

        async function fetchAPI(payload) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                Swal.fire('Connection Error', 'ไม่สามารถเชื่อมต่อกับ Server ได้', 'error');
                return null;
            }
        }

        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));
            document.getElementById(viewId).classList.add('active-view');
            window.scrollTo(0, 0);
        }

        // --- LOGIN FUNCTION ---
        async function doLogin() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            
            if(!u) { Swal.fire('แจ้งเตือน', 'กรุณากรอก Username', 'warning'); return; }

            Swal.fire({title: 'กำลังตรวจสอบ...', didOpen: ()=>Swal.showLoading()});
            
            const res = await fetchAPI({ action: 'login', u: u, p: p });
            Swal.close();

            if (res && res.status === true) {
                currentUser = res;
                document.getElementById('dispName').innerText = res.name;
                
                let imgUrl = "https://cdn-icons-png.flaticon.com/512/149/149071.png"; 
                if (res.photo) imgUrl = `https://drive.google.com/thumbnail?id=${res.photo}&sz=w100`;
                document.getElementById('userImg').src = imgUrl;

                loadPortalApps(res.roles);
                switchView('view-portal');
            } 
            else if (res && res.status === 'SET_PASSWORD') {
                tempUserForSetup = res.user; 
                document.getElementById('newPass').value = '';
                document.getElementById('confirmPass').value = '';
                switchView('view-set-password'); 
            } 
            else {
                Swal.fire('เข้าสู่ระบบไม่สำเร็จ', res ? res.message : 'Error', 'error');
            }
        }

        let tempUserForSetup = '';
        async function doSetNewPassword() {
            const p1 = document.getElementById('newPass').value;
            const p2 = document.getElementById('confirmPass').value;
            if (p1.length < 6) { Swal.fire('รหัสผ่านสั้นเกินไป', 'ต้องมีความยาวอย่างน้อย 6 ตัวอักษร', 'warning'); return; }
            if (p1 !== p2) { Swal.fire('รหัสผ่านไม่ตรงกัน', 'กรุณากรอกช่องยืนยันให้ตรงกับรหัสผ่าน', 'warning'); return; }

            Swal.fire({title: 'กำลังบันทึก...', didOpen: ()=>Swal.showLoading()});
            const res = await fetchAPI({ action: 'setPassword', u: tempUserForSetup, newPass: p1 });
            Swal.close();

            if (res && res.status) {
                await Swal.fire('สำเร็จ', 'บันทึกรหัสผ่านเรียบร้อย กรุณาเข้าสู่ระบบใหม่', 'success');
                switchView('view-login');
                document.getElementById('password').value = '';
            } else {
                Swal.fire('Error', 'บันทึกไม่สำเร็จ: ' + (res ? res.message : ''), 'error');
            }
        }

        function doLogout() {
            currentUser = null;
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            switchView('view-login');
        }

        // --- PORTAL FUNCTION ---
        async function loadPortalApps(roles) {
            const grid = document.getElementById('appGrid');
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center;">Loading...</div>';

            const res = await fetchAPI({ action: 'getSystems', roles: roles });
            
            if (res && res.status) {
                grid.innerHTML = '';
                res.systems.forEach(sys => {
                    let iconHtml = sys.icon.includes('http') 
                        ? `<img src="${sys.icon}" style="height:40px; margin-bottom:10px;">` 
                        : `<i class="${sys.icon}"></i>`;
                    
                    // Badge Logic สำหรับ Job Cost
                    let badgeHtml = '';
                    if (sys.id === 'JOBCOST' && sys.lastPeriod) {
                        lastJobPeriodGlobal = sys.lastPeriod;
                        let parts = sys.lastPeriod.split('-');
                        let badgeTxt = `${parts[1]}/${parts[0]}`;
                        
                        // *** ใช้ <span> เพื่อให้อยู่บรรทัดเดียวกัน ***
                        badgeHtml = `<span class="period-badge">Last: ${badgeTxt}</span>`;
                    }

                    let el = document.createElement('div');
                    el.className = 'app-icon';
                    
                    // *** เอา badgeHtml ต่อท้ายชื่อ ใน div เดียวกัน ***
                    el.innerHTML = `${iconHtml}<div>${sys.name}${badgeHtml}</div>`;
                    
                    el.onclick = () => openSystem(sys.id);
                    grid.appendChild(el);
                });
            } else {
                grid.innerHTML = 'ไม่พบรายการระบบ';
            }
        }

        function openSystem(sysId) {
            if (sysId === 'SALE') {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                document.getElementById('monthPicker').value = `${year}-${month}`;
                switchView('view-app-sale');
                processSaleData(); 
            } 
            else if (sysId === 'JOBCOST') {
                // ถ้ามี Last Period ให้ตั้งเป็น Default, ถ้าไม่มีใช้เดือนปัจจุบัน
                let defaultMonth = lastJobPeriodGlobal;
                if (!defaultMonth) {
                    const now = new Date();
                    defaultMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                }
                
                document.getElementById('jobMonthPicker').value = defaultMonth;
                switchView('view-app-jobcost');
                processJobCostData(); // โหลดข้อมูลทันที
            }
            else {
                Swal.fire('Info', 'ระบบ ' + sysId + ' กำลังอยู่ในระหว่างพัฒนา', 'info');
            }
        }

        function onDateChanged(appType) {
            if(appType === 'sale') {
                document.getElementById('dashboardContent').style.display = 'none';
            } else if(appType === 'job') {
                document.getElementById('jobContent').style.display = 'none';
                document.getElementById('emptyJob').style.display = 'none';
            }
        }

        // ******************************************************
        // JOB COST LOGIC (NEW)
        // ******************************************************
        
        async function processJobCostData() {
            var monthVal = document.getElementById('jobMonthPicker').value;
            if (!monthVal) { Swal.fire('เตือน', "กรุณาเลือกเดือน/ปี", 'warning'); return; }
            
            document.getElementById('jobContent').style.display = 'none';
            document.getElementById('emptyJob').style.display = 'none';
            document.getElementById('loadingJob').style.display = 'block';

            const res = await fetchAPI({ action: 'getJobCostData', month: monthVal });
            
            document.getElementById('loadingJob').style.display = 'none';

            if (res && res.status) {
                if(res.details.length === 0) {
                    document.getElementById('emptyJob').style.display = 'block';
                    return;
                }

                document.getElementById('jobContent').style.display = 'block';

                // 1. Group by PN
                let groupedData = aggregateJobData(res.details);
                
                // 2. Summary
                let sumRev = 0, sumCost = 0, sumProfit = 0;
                groupedData.forEach(d => {
                    sumRev += d.revenue;
                    sumCost += d.totalCost;
                    sumProfit += d.profit;
                });
                
                let sumPct = (sumRev > 0) ? (sumProfit / sumRev * 100) : 0;

                document.getElementById('jobSumRev').innerText = formatMillion(sumRev);
                document.getElementById('jobSumCost').innerText = formatMillion(sumCost);
                document.getElementById('jobSumProfit').innerText = formatMillion(sumProfit);
                document.getElementById('jobSumPct').innerText = sumPct.toFixed(2) + '%';
                
                // Colorize Profit
                document.getElementById('jobSumProfit').style.color = sumProfit >= 0 ? '#2e7d32' : '#c62828';

                // 3. Render List
                renderJobList(groupedData);

            } else {
                Swal.fire('Error', res ? res.error : 'Unknown Error', 'error');
            }
        }

        function aggregateJobData(details) {
            let map = {};
            details.forEach(item => {
                let pn = item.pn || "No PN";
                if (!map[pn]) {
                    map[pn] = {
                        pn: pn,
                        partName: item.partName,
                        qty: 0,
                        revenue: 0,
                        totalCost: 0,
                        profit: 0
                    };
                }
                map[pn].qty += item.qty;
                map[pn].revenue += item.revenue;
                map[pn].totalCost += item.totalCost;
                map[pn].profit += item.profit;
            });
            // Convert to Array & Sort by Profit Descending
            return Object.values(map).sort((a,b) => b.profit - a.profit);
        }

        function renderJobList(data) {
            let html = '';
            
            data.forEach((item, index) => {
                // คำนวณ %
                let pct = (item.revenue > 0) ? (item.profit / item.revenue * 100) : 0;
                
                // กำหนดสี
                let profitColor = item.profit >= 0 ? '#2e7d32' : '#c62828'; 
                let pctColor = pct >= 0 ? '#2e7d32' : '#c62828';

                html += `
                <div class="job-table-template job-data-row" onclick="openJobDetail(${index})">
                    <div style="font-weight:bold; color:var(--primary-color); word-break:break-word; line-height:1.1;">${item.pn}</div>
                    
                    <div class="text-right" style="font-weight:600;">${formatNum(item.qty)}</div>
                    
                    <div class="text-right text-gray">${formatNum(item.revenue)}</div>
                    
                    <div class="text-right text-gray">${formatNum(item.totalCost)}</div>
                    
                    <div class="text-right" style="font-weight:bold; color:${profitColor};">${formatNum(item.profit)}</div>
                    
                    <div class="text-right" style="font-weight:bold; color:${pctColor}; font-size:9px;">${pct.toFixed(1)}%</div>
                </div>`;
            });
            
            document.getElementById('jobList').innerHTML = html;
        }

        // ฟังก์ชัน Dummy สำหรับรองรับการคลิก (เดี๋ยวค่อยมาทำรายละเอียด)
        function openJobDetail(index) {
            // ตอนนี้ยังไม่ต้องทำอะไร หรือจะ Alert ดูก่อนก็ได้ครับ
            // Swal.fire('Selected', 'คุณเลือกรายการลำดับที่ ' + index, 'info');
        }

        // ******************************************************
        // SALES DASHBOARD LOGIC (Existing)
        // ******************************************************
        
        let overviewChart, customerChart, detailChart, categoryChart;
        let globalAggregatedData = [];

        async function processSaleData() {
            var monthVal = document.getElementById('monthPicker').value;
            if (!monthVal) { Swal.fire('เตือน', "กรุณาเลือกเดือน/ปี", 'warning'); return; }
            
            document.getElementById('dashboardContent').style.display = 'none';
            document.getElementById('loadingSale').style.display = 'block';

            const res = await fetchAPI({ action: 'getSaleData', month: monthVal });
            
            document.getElementById('loadingSale').style.display = 'none';

            if (res && res.status) {
                document.getElementById('dashboardContent').style.display = 'block';

                if (monthVal) {
                    var parts = monthVal.split('-');
                    var yearThai = parseInt(parts[0]) + 543;
                    document.getElementById('chartTitleText').innerText = "ภาพรวมประจำเดือน " + parts[1] + "/" + yearThai + " (ล้านบาท)";
                }
                document.getElementById('lastUpdatedTxt').innerText = res.lastUpdated;

                globalAggregatedData = aggregateData(res.details);

                let totalSales = 0, totalBacklog = 0, totalSent = 0, totalPastDue = 0;
                globalAggregatedData.forEach(c => {
                    totalSales += c.totalSales;
                    totalBacklog += c.totalBacklog;
                    totalSent += c.totalSent;
                    totalPastDue += c.totalPastDue;
                });

                // *** จุดที่แก้ไข: คำนวณยอดรอส่งสุทธิ (เอา Backlog ตั้ง - Past Due ออก) ***
                let netTotalBacklog = Math.max(0, totalBacklog - totalPastDue);

                document.getElementById('sumSales').innerText = formatNum(totalSales);
                
                // ใช้ยอดสุทธิที่คำนวณใหม่แสดงในช่อง "รอส่ง"
                document.getElementById('sumBacklog').innerText = formatNum(netTotalBacklog); 
                
                document.getElementById('sumSent').innerText = formatNum(totalSent);
                document.getElementById('sumDue').innerText = formatNum(totalPastDue);

                drawOverviewChart(totalSales, totalBacklog, totalSent, totalPastDue);
                
                globalAggregatedData.sort((a, b) => b.totalSales - a.totalSales);
                
                drawCustomerChart(globalAggregatedData);
                renderList(globalAggregatedData);

            } else {
                Swal.fire('Error', res ? res.error : 'Unknown Error', 'error');
            }
        }

        function aggregateData(rawDetails) {
            let map = {};
            if (!rawDetails || rawDetails.length === 0) return [];
            rawDetails.forEach(item => {
                let name = item.customer || "ไม่ระบุชื่อ";
                let dueDate = item.dueDate; 
                let sales = Number(item.sales || 0);
                let backlog = Number(item.backlog || 0);
                let sent = Number(item.sent || 0);
                let pastDue = Number(item.pastDue || 0);
                
                // กรองค่าที่เป็น 0 ทั้งหมดออก
                if (sales === 0 && backlog === 0 && sent === 0 && pastDue === 0) return;

                if (!map[name]) {
                    map[name] = { name: name, totalSales: 0, totalBacklog: 0, totalSent: 0, totalPastDue: 0, history: [] };
                }
                map[name].totalSales += sales;
                map[name].totalBacklog += backlog;
                map[name].totalSent += sent;
                map[name].totalPastDue += pastDue;
                map[name].history.push({ date: formatDateStr(dueDate), sales: sales, backlog: backlog, sent: sent, pastDue: pastDue });
            });
            return Object.values(map);
        }

        function drawOverviewChart(sales, backlog, sent, due) {
            let netBacklog = Math.max(0, backlog - due);
            const ctx = document.getElementById('overviewChart').getContext('2d');
            if (overviewChart) overviewChart.destroy();
            
            overviewChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ส่งแล้ว', 'รอส่ง', 'Past Due'],
                    datasets: [{
                        data: [sent, netBacklog, due],
                        backgroundColor: ['#66bb6a', '#ffa726', '#ef5350'],
                        borderWidth: 2, borderColor: '#ffffff', hoverOffset: 4
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    onClick: (e, activeEls) => { if (activeEls.length > 0) openCategoryModal(activeEls[0].index); }
                }
            });

            const legendItems = [
                { label: 'ยอดรวม', value: sales, color: '#42a5f5', index: 3 },
                { label: 'ส่งแล้ว', value: sent, color: '#66bb6a', index: 0 },
                { label: 'รอส่ง', value: netBacklog, color: '#ffa726', index: 1 }, 
                { label: 'Past Due', value: due, color: '#ef5350', index: 2 },
                { label: 'รอส่ง+PastDue', value: backlog, color: '#8d6e63', index: 4 } 
            ];
            let html = '<ul style="list-style: none; padding: 0; margin: 0; font-size: 13px;">';
            legendItems.forEach(item => {
                let clickAction = (typeof item.index !== 'undefined') ? `onclick="openCategoryModal(${item.index})"` : '';
                html += `<li ${clickAction} style="display: flex; align-items: center; margin-bottom: 8px; color: #333; cursor: pointer;">
                    <span style="flex-shrink:0; width:12px; height:12px; background-color:${item.color}; margin-right:8px; border-radius:3px;"></span>
                    <span style="margin-right: 5px; white-space: nowrap;">${item.label}</span>
                    <span style="font-weight:bold; margin-left:auto;">${formatMillion(item.value)}</span> 
                </li>`;
            });
            html += '</ul>';
            document.getElementById('customLegend').innerHTML = html;
        }

        function drawCustomerChart(data) {
            const ctx = document.getElementById('customerChart').getContext('2d');
            const top5 = data.slice(0, 5); 
            const labels = top5.map(d => {
                let n = d.name.replace(/บริษัท|จำกัด|company|ltd\.|co\.,/gi, '').trim();
                return n.length > 10 ? n.substring(0, 10) + '..' : n;
            });

            if (customerChart) customerChart.destroy();

            customerChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ส่งแล้ว', data: top5.map(d => d.totalSent), backgroundColor: '#66bb6a', stack: 'Stack 0' },
                        { label: 'ค้างส่ง', data: top5.map(d => Math.max(0, d.totalBacklog - d.totalPastDue)), backgroundColor: '#ffa726', stack: 'Stack 0' },
                        { label: 'Past Due', data: top5.map(d => d.totalPastDue), backgroundColor: '#ef5350', stack: 'Stack 0' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    onClick: (e, activeEls) => { if(activeEls.length > 0) openModal(top5[activeEls[0].index]); },
                    scales: { x: { stacked: true, grid: { display: false } }, y: { stacked: true, beginAtZero: true } },
                    plugins: { 
                        legend: { position: 'bottom', labels: { font: { size: 12 }, boxWidth: 12, padding: 15 } },
                        tooltip: {enabled: false, callbacks: { label: function(context) { return context.dataset.label + ': ' + formatNum(context.raw); } } }
                    }
                }
            });
        }

        function renderList(data) {
            var html = '';
            if (data.length === 0) { html = '<div style="text-align:center; margin-top:20px;">ไม่พบข้อมูล</div>'; } 
            else {
                data.forEach(function(item, index) {
                    var borderClass = (item.totalPastDue > 0) ? 'has-due' : 'no-due';
                    var dueStyle = (item.totalPastDue > 0) ? 'class="text-red"' : '';
                    html += `<div class="list-item ${borderClass}" onclick="openModalByIndex(${index})">
                        <div class="cust-header"><div class="cust-name">${item.name}</div><div style="font-size:10px; color:#999;">ดูรายละเอียด ></div></div>
                        <div class="row-detail"><span class="text-gray">ยอดขายรวม:</span><span class="text-blue">${formatNum(item.totalSales)}</span></div>
                        <div class="row-detail"><span class="text-gray">ส่งแล้ว:</span><span class="text-green">${formatNum(item.totalSent)}</span></div>
                        <div class="row-detail"><span class="text-gray">ค้างส่ง (รวม Past Due):</span><span class="text-orange">${formatNum(item.totalBacklog)}</span></div>
                        <div class="row-detail"><span class="text-red">Past Due:</span><span ${dueStyle}>${formatNum(item.totalPastDue)}</span></div>
                    </div>`;
                });
            }
            document.getElementById('dataList').innerHTML = html;
        }

        function openModalByIndex(index) { openModal(globalAggregatedData[index]); }
        function openModal(customerData) {
            document.getElementById('detailModal').style.display = 'flex';
            document.getElementById('modalCustName').innerText = customerData.name;
            // *** เพิ่มบรรทัดนี้ครับ ***
            document.getElementById('modalCustTotal').innerText = 'ยอดรวม: ' + formatNum(customerData.totalSales);
            
            customerData.history.sort((a, b) => new Date(a.date) - new Date(b.date));

            const ctx = document.getElementById('detailChart').getContext('2d');
            if (detailChart) detailChart.destroy();

            const labels = customerData.history.map(h => {
                if (h.date && h.date.includes('-')) {
                    let parts = h.date.split('-');
                    let d = new Date(parts[0], parts[1] - 1, parts[2]); 
                    return d.getDate() + "/" + (d.getMonth() + 1);
                }
                let d = new Date(h.date);
                return isNaN(d) ? h.date : d.getDate() + "/" + (d.getMonth()+1);
            });
            let custNetBacklog = Math.max(0, customerData.totalBacklog - customerData.totalPastDue);

            detailChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ส่ง: ' + formatNum(customerData.totalSent), data: customerData.history.map(h => h.sent), backgroundColor: '#66bb6a' },
                        { label: 'ค้าง: ' + formatNum(custNetBacklog), data: customerData.history.map(h => Math.max(0, h.backlog - h.pastDue)), backgroundColor: '#ffa726' },
                        { label: 'Due: ' + formatNum(customerData.totalPastDue), data: customerData.history.map(h => h.pastDue), backgroundColor: '#ef5350' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } },
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { size: 12, weight: 'bold' }, boxWidth: 12, padding: 15 } },
                        tooltip: {enabled: false, callbacks: { label: function(context) { let labelName = context.dataset.label.split(':')[0]; return labelName + ': ' + formatNum(context.raw); } } }
                    }
                }
            });

            let tableHtml = `<table style="width:100%; border-collapse: collapse; text-align:right; font-size:13px;">
             <tr style="background:#f5f5f5; text-align:center; font-weight:bold; color:#555;">
                <th style="padding:8px;">วันที่</th><th style="padding:8px;">ส่ง</th><th style="padding:8px;">ค้าง</th><th style="padding:8px;">Due</th>
             </tr>`;
            customerData.history.forEach(h => {
                let rowNetBacklog = Math.max(0, h.backlog - h.pastDue);
                tableHtml += `<tr style="border-bottom:1px solid #eee;">
                    <td style="text-align:center; padding:6px; color:#555;">${h.date}</td>
                    <td style="padding:6px; color:#66bb6a;">${formatNum(h.sent)}</td>
                    <td style="padding:6px; color:#ffa726;">${formatNum(rowNetBacklog)}</td>
                    <td style="padding:6px; color:#ef5350;">${formatNum(h.pastDue)}</td>
                </tr>`;
            });
            tableHtml += `</table>`;
            document.getElementById('modalTable').innerHTML = tableHtml;
        }

        function openCategoryModal(typeIndex) {
          typeIndex = Number(typeIndex); 
          
          if (!globalAggregatedData || globalAggregatedData.length === 0) {
              Swal.fire('ข้อผิดพลาด', 'ไม่พบข้อมูลตั้งต้น', 'error');
              return;
          }
          
          let title = '';
          let processedData = [];

          // 1. เตรียมข้อมูล
          processedData = globalAggregatedData.map(d => {
              let val = 0; 
              if (typeIndex === 0) {
                  val = d.totalSent; title = 'รายการส่งแล้ว (Sent)';
              } else if (typeIndex === 1) {
                  val = Math.max(0, d.totalBacklog - d.totalPastDue); title = 'รายการรอส่ง (ไม่รวม Past Due)';
              } else if (typeIndex === 2) {
                  val = d.totalPastDue; title = 'รายการเกินกำหนด (Past Due)';
              } else if (typeIndex === 3) {
                  val = d.totalSales; title = 'ยอดขายรวมทั้งหมด (แยกตามสถานะ)';
              } else if (typeIndex === 4) {
                  val = d.totalBacklog; title = 'รายการรอส่งทั้งหมด (รวม Past Due)';
              }
              return { ...d, sortValue: val };
          });

          // 2. กรองและเรียงลำดับ
          let filteredData = processedData.filter(d => d.sortValue > 0);
          filteredData.sort((a, b) => b.sortValue - a.sortValue);

          // ตัดเหลือ 15 รายการ
          if (filteredData.length > 15) filteredData = filteredData.slice(0, 15);

          if (filteredData.length === 0) {
              Swal.fire('ไม่มีข้อมูล', 'ไม่มีรายการในหมวดหมู่นี้', 'info');
              return;
          }

          let totalValue = filteredData.reduce((sum, item) => sum + item.sortValue, 0);
          document.getElementById('catModalSubtitle').innerText = `รวมมูลค่า ${formatMillion(totalValue)} ล้านบาท`;

          let dynamicHeight = (filteredData.length * 35) + 60; 
          document.getElementById('categoryChartContainer').style.height = dynamicHeight + 'px';

          let labels = filteredData.map(d => {
              let n = d.name.replace(/บริษัท|ห\.?จ\.?ก\.?|ห้างหุ้นส่วนจำกัด|จำกัด|[(]?มหาชน[)]?|company|ltd\.?|co\.?|inc\.?/gi, '');
              n = n.replace(/[(].*?[)]/g, '').split('สาขา')[0].trim();
              return n.length > 15 ? n.substring(0, 15) + '..' : n;
          });

          // 3. สร้าง Datasets
          let datasets = [];
          let isStacked = false; 

          if (typeIndex === 3) {
              // กราฟยอดรวมแบบ Stack
              isStacked = true;
              datasets = [
                  { label: 'ส่งแล้ว', data: filteredData.map(d => d.totalSent), backgroundColor: '#66bb6a', stack: 'totalStack', barPercentage: 0.6, categoryPercentage: 0.9 },
                  { label: 'รอส่ง', data: filteredData.map(d => Math.max(0, d.totalBacklog - d.totalPastDue)), backgroundColor: '#ffa726', stack: 'totalStack', barPercentage: 0.6, categoryPercentage: 0.9 },
                  { label: 'Past Due', data: filteredData.map(d => d.totalPastDue), backgroundColor: '#ef5350', stack: 'totalStack', barPercentage: 0.6, categoryPercentage: 0.9 }
              ];
          } else {
              // กราฟปกติ
              let singleColor = '#42a5f5'; 
              if (typeIndex === 0) singleColor = '#66bb6a';
              else if (typeIndex === 1) singleColor = '#ffa726';
              else if (typeIndex === 2) singleColor = '#ef5350';
              else if (typeIndex === 4) singleColor = '#8d6e63';

              datasets = [{
                  data: filteredData.map(d => d.sortValue),
                  backgroundColor: singleColor,
                  barPercentage: 0.6, categoryPercentage: 0.9 
              }];
          }

          // เปิด Modal
          document.getElementById('categoryModal').style.display = 'flex';
          document.getElementById('catModalTitle').innerText = title;

          const ctx = document.getElementById('categoryChart').getContext('2d');
          if (categoryChart) categoryChart.destroy();

          // *** PLUGIN พิเศษ: วาดตัวเลขรวมที่ปลายกราฟ Stack ***
          const totalLabelPlugin = {
              id: 'totalLabelPlugin',
              afterDatasetsDraw: function(chart) {
                  // ทำงานเฉพาะตอนเป็น Stacked Chart (Index 3)
                  if (!isStacked) return;

                  const ctx = chart.ctx;
                  
                  // ดึง Meta ของ Dataset ตัวสุดท้าย (ตัวที่อยู่ขวาสุด)
                  const meta = chart.getDatasetMeta(chart.data.datasets.length - 1);
                  
                  chart.data.labels.forEach((label, index) => {
                      // คำนวณยอดรวมของ Row นั้น
                      let total = 0;
                      chart.data.datasets.forEach(ds => {
                          total += ds.data[index];
                      });

                      // หาตำแหน่งปลายสุดของแท่งกราฟ
                      const bar = meta.data[index];
                      if (bar) {
                          const xPos = bar.x; // ปลายสุดแกน X
                          const yPos = bar.y; // ตำแหน่งแกน Y

                          // วาดตัวเลข
                          ctx.save();
                          ctx.font = "bold 11px 'Prompt'"; // ฟอนต์เดียวกับระบบ
                          ctx.fillStyle = '#333';          // สีเทาเข้ม
                          ctx.textAlign = 'left';
                          ctx.textBaseline = 'middle';
                          // วาดห่างออกมา 5px
                          ctx.fillText(formatMillion(total), xPos + 5, yPos);
                          ctx.restore();
                      }
                  });
              }
          };

          categoryChart = new Chart(ctx, {
              type: 'bar',
              plugins: [ChartDataLabels, totalLabelPlugin], // ใส่ Plugin เพิ่มเข้าไป
              data: { labels: labels, datasets: datasets },
              options: {
                  indexAxis: 'y',
                  animation: false, 
                  responsive: true, maintainAspectRatio: false,
                  
                  // เพิ่ม Padding ขวาเป็น 55 เพื่อให้เลขยอดรวมไม่ตกขอบ
                  layout: { padding: { right: 55, left: 0 } },
                  
                  events: ['click', 'touchstart'], 
                  interaction: { mode: 'nearest', axis: 'y', intersect: false },
                  onClick: (e) => {
                      const chart = e.chart;
                      const canvasPosition = Chart.helpers.getRelativePosition(e, chart);
                      const dataY = chart.scales.y.getValueForPixel(canvasPosition.y);
                      const index = Math.round(dataY);
                      if (index >= 0 && index < filteredData.length) {
                          setTimeout(() => { openModal(filteredData[index]); }, 50);
                      }
                  },
                  scales: {
                      x: { display: false, stacked: isStacked },
                      y: { stacked: isStacked, grid: { display: false }, ticks: { font: { size: 11 }, color: '#333', autoSkip: false } }
                  },
                  plugins: {
                      legend: { 
                          display: isStacked, 
                          position: 'bottom',
                          labels: { boxWidth: 10, font: { size: 10 } }
                      },
                      datalabels: {
                          // ตัวเลขข้างในแท่ง (ถ้าไม่ใช่ Stack ให้แสดงปลายแท่งเหมือนเดิม)
                          anchor: isStacked ? 'center' : 'end', 
                          align: isStacked ? 'center' : 'end', 
                          color: isStacked ? '#fff' : '#555', 
                          font: { weight: 'bold', size: 10 },
                          formatter: function(value) { 
                              if (value <= 0) return '';
                              // ถ้าเป็น Stack ให้แสดงหน่วยล้าน (จะได้สั้นๆ) ถ้ากราฟเดี่ยวแสดงปกติ
                              return isStacked ? formatMillion(value) : formatMillion(value); 
                          }
                      },
                      tooltip: { 
                          enabled: false,
                          callbacks: {
                              label: function(context) {
                                  let label = context.dataset.label || '';
                                  if (label) label += ': ';
                                  label += formatNum(context.raw);
                                  return label;
                              }
                          }
                      } 
                  }
              }
          });
      }

        // Utils & Event Handling
        function closeModal() { document.getElementById('detailModal').style.display = 'none'; }
        function closeCategoryModal() { document.getElementById('categoryModal').style.display = 'none'; }
        
        window.onclick = function(event) {
            if (event.target == document.getElementById('detailModal')) closeModal();
            if (event.target == document.getElementById('categoryModal')) closeCategoryModal();
        }

        function formatNum(num) { return new Intl.NumberFormat('th-TH', { maximumFractionDigits: 0 }).format(num); }
        function formatDateStr(dateVal) { return (dateVal && dateVal.includes('T')) ? dateVal.split('T')[0] : (dateVal || "-"); }
        function formatMillion(num) { return (num >= 1000000) ? (num / 1000000).toFixed(2) : formatNum(num); }

        document.addEventListener('DOMContentLoaded', () => history.pushState(null, null, location.href));
        window.onpopstate = function () {
            if (document.getElementById('detailModal').style.display === 'flex') { closeModal(); history.pushState(null, null, location.href); }
            else if (document.getElementById('categoryModal').style.display === 'flex') { closeCategoryModal(); history.pushState(null, null, location.href); }
            else if (document.getElementById('view-app-sale').classList.contains('active-view') || document.getElementById('view-app-jobcost').classList.contains('active-view')) { 
                switchView('view-portal'); history.pushState(null, null, location.href); 
            }
            else if (document.getElementById('view-set-password').classList.contains('active-view')) {
                switchView('view-login'); history.pushState(null, null, location.href);
            }
            else { history.back(); }
        };
    </script>
</body>
</html>
